name: ðŸ³ Build & Push Docker Image

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: xlokius/hensearch
  
jobs:
  build-and-push:
    name: ðŸ³ Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Check files
      run: |
        echo "ðŸ“ Current directory contents:"
        ls -la
        echo ""
        echo "ðŸ“„ Dockerfile content:"
        cat Dockerfile
        echo ""
        echo "ðŸ“‚ Docs directory:"
        ls -la docs/
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ·ï¸ Generate Docker tags
      id: meta
      run: |
        # Generate timestamp
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # Get short commit hash
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        
        # For main branch, always build and push
        DOCKER_TAG="latest"
        VERSION_TAG="v1.3.0"
        PUSH_IMAGE="true"
        
        echo "docker-tag=${DOCKER_TAG}" >> $GITHUB_OUTPUT
        echo "version-tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
        echo "commit-short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
        echo "push-image=${PUSH_IMAGE}" >> $GITHUB_OUTPUT
        
        echo "ðŸ·ï¸ Generated tags:"
        echo "Main tag: ${DOCKER_TAG}"
        echo "Version tag: ${VERSION_TAG}"
        echo "Commit: ${COMMIT_SHORT}"
        echo "Will push: ${PUSH_IMAGE}"
    
    - name: ðŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ðŸ—ï¸ Build Docker image
      run: |
        echo "ðŸ—ï¸ Building Docker image..."
        
        # Build the image
        docker build -t ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.docker-tag }} .
        
        # Tag with version if it's a main branch build
        if [ -n "${{ steps.meta.outputs.version-tag }}" ]; then
          docker tag ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.docker-tag }} ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version-tag }}
        fi
        
        echo "âœ… Docker image built successfully"
        
        # Show image info
        echo "ðŸ“Š Image information:"
        docker images ${{ env.IMAGE_NAME }}
    
    - name: ðŸ§ª Test Docker image
      run: |
        echo "ðŸ§ª Testing Docker image..."
        
        # Run container in background
        docker run -d --name test-container -p 8080:80 ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.docker-tag }}
        
        # Wait for container to start
        echo "â³ Waiting for container to start..."
        sleep 15
        
        # Check if container is running
        if docker ps | grep -q test-container; then
          echo "âœ… Container is running"
        else
          echo "âŒ Container failed to start"
          docker logs test-container
          exit 1
        fi
        
        # Test HTTP response
        echo "ðŸŒ Testing HTTP response..."
        for i in {1..10}; do
          if curl -f http://localhost:8080 >/dev/null 2>&1; then
            echo "âœ… HTTP test passed"
            break
          fi
          
          if [ $i -eq 10 ]; then
            echo "âŒ HTTP test failed after 10 attempts"
            docker logs test-container
            exit 1
          fi
          
          echo "â³ Attempt $i failed, retrying..."
          sleep 3
        done
        
        # Test page content
        CONTENT=$(curl -s http://localhost:8080 | grep -o "HenSearch\|TMOHentai" | head -1)
        if [ -n "$CONTENT" ]; then
          echo "âœ… Page content test passed (found: $CONTENT)"
        else
          echo "âŒ Page content test failed"
          curl -s http://localhost:8080 | head -10
        fi
        
        # Cleanup
        docker stop test-container
        docker rm test-container
        
        echo "ðŸŽ‰ All tests passed!"
    
    - name: ðŸš€ Push to Docker Hub
      run: |
        echo "ðŸš€ Pushing Docker image to Docker Hub..."
        
        # Push main tag
        docker push ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.docker-tag }}
        
        # Push version tag
        docker push ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version-tag }}
        
        echo "âœ… Docker image pushed successfully!"
        echo "ðŸ”— Available at: https://hub.docker.com/r/xlokius/hensearch"
    
    - name: ðŸ“‹ Summary
      if: always()
      run: |
        echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ steps.meta.outputs.commit-short }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Tags**: \`latest\`, \`v1.3.0\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Built and pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Usage" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 80:80 --name hensearch ${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Docker Hub](https://hub.docker.com/r/xlokius/hensearch)" >> $GITHUB_STEP_SUMMARY
        echo "- [GitHub Repository](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY